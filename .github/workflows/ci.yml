name: CI
on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: windows-latest
    steps:

      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install Rubberduck via Chocolatey
        shell: pwsh
        run: |
          choco install rubberduck -y

      - name: Check for VBA modules
        id: vba_check
        shell: pwsh
        run: |
          # load the ZIP APIs
          Add-Type -AssemblyName System.IO.Compression.FileSystem

          $xlsmPath = "workbook\ETL_Accelerator.xlsm"
          $found = $false

          try {
            $zip = [System.IO.Compression.ZipFile]::OpenRead($xlsmPath)
            if ($zip.Entries | Where-Object { $_.FullName -eq 'xl/vbaProject.bin' }) {
              $found = $true
            }
            $zip.Dispose()
          }
          catch {
            Write-Warning "⚠️ ZIP inspection failed: $($_.Exception.Message)"
            Write-Warning "Assuming VBA modules are present so we don’t skip the CLI."
            $found = $true
          }

          Write-Output "hasModules=$found" | Out-File -FilePath $GITHUB_OUTPUT -Encoding UTF8

      - name: Inspect & Run VBA Tests
        if: steps.vba_check.outputs.hasModules == 'true'
        shell: pwsh
        run: |
          Write-Host "✅ VBA detected — running Rubberduck CLI"
          Rubberduck.CLI.exe inspect `
            --project "workbook\ETL_Accelerator.xlsm" `
            --tests all

      - name: Skip Rubberduck (no VBA)
        if: steps.vba_check.outputs.hasModules != 'true'
        shell: pwsh
        run: |
          Write-Host "ℹ️  No VBA modules detected; skipping Rubberduck CLI."
