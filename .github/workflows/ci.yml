name: CI

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: windows-latest
    steps:

      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install Rubberduck via Chocolatey
        shell: pwsh
        run: |
          choco install rubberduck -y

      - name: Check for VBA modules
        id: vba_check
        shell: pwsh
        run: |
          # load .NET ZIP support
          Add-Type -AssemblyName System.IO.Compression.FileSystem

          # point at your workbook
          $xlsmPath = "workbook\ETL_Accelerator.xlsm"

          # open the .xlsm as a zip and look for the VBA project stream
          $zip = [System.IO.Compression.ZipFile]::OpenRead($xlsmPath)
          $hasVba = $zip.Entries | Where-Object { $_.FullName -eq 'xl/vbaProject.bin' }
          $zip.Dispose()

          # export a boolean flag
          $found = ($hasVba -ne $null)
          Write-Output "hasModules=$found" | Out-File -FilePath $GITHUB_OUTPUT -Encoding UTF8

      - name: Inspect & Run VBA Tests
        if: steps.vba_check.outputs.hasModules == 'true'
        shell: pwsh
        run: |
          Write-Host "✅ VBA found – running Rubberduck CLI"
          Rubberduck.CLI.exe inspect `
            --project "workbook\ETL_Accelerator.xlsm" `
            --tests all

      - name: Skip Rubberduck (no VBA)
        if: steps.vba_check.outputs.hasModules != 'true'
        shell: pwsh
        run: |
          Write-Host "ℹ️ No VBA modules detected; skipping Rubberduck CLI."
